# Plan: Thread System Metadata (`meta.json`)

## Goal
Track per-thread system inventory (files/KB/DB/reminders) in a lightweight, local file so Executive Assistant can route requests without guessing.

**Location**: `data/users/{thread_id}/meta.json`

## Proposed Schema (v1)
```json
{
  "thread_id": "telegram:123",
  "updated_at": "2026-01-16T18:10:00Z",
  "files": {
    "paths": ["notes/mfa.txt", "docs/contract.pdf"],
    "count": 2,
    "last_updated": "2026-01-16T18:10:00Z"
  },
  "kb": {
    "tables": ["mfa_agreement"],
    "last_updated": "2026-01-16T18:10:00Z"
  },
  "db": {
    "path": "db/db.db",
    "tables": ["timesheet"],
    "last_updated": "2026-01-16T18:10:00Z"
  },
  "reminders": {
    "count": 3,
    "last_updated": "2026-01-16T18:10:00Z"
  }
}
```
- Keep lists bounded (e.g., max 200 paths) to avoid bloat.
- Store file paths relative to the thread files root.
- Best-effort updates (never fail the userâ€™s tool call if meta write fails).

## Update Triggers
- **Files**: `write_file`, `move_file`, `delete_folder`, `rename_folder` update file paths list.
- **KB**: `create_kb_table`, `drop_kb_table`, `add_kb_documents`, `delete_kb_documents` update table list.
- **DB**: `create_db_table`, `delete_db_table`, `import_db_table` update table list (and DB path once).
- **Reminders**: `reminder_set`, `reminder_cancel`, `reminder_edit`, `reminder_list` refresh reminder count.

## Implementation Steps
1. Add `src/executive_assistant/storage/meta_registry.py` for load/save/update helpers and atomic writes.
2. Wire file operations in `src/executive_assistant/storage/file_sandbox.py` to update meta.
3. Wire KB operations in `src/executive_assistant/storage/kb_tools.py` to update meta.
4. Wire DB operations in `src/executive_assistant/storage/db_tools.py` to update meta.
5. Wire reminder operations in `src/executive_assistant/tools/reminder_tools.py` to update meta counts.
6. Add `refresh_meta(thread_id)` utility to rebuild the inventory by scanning files/KB/DB/reminders.
7. Add `/meta` command + `get_meta` tool for viewing inventory (supports `refresh` and `json`).
8. Keep updates best-effort (log/ignore errors).

## Notes
- `get_meta` tool and `/meta` command provide read-only access to inventory.
- `meta.json` is local-only; it can be safely regenerated by `refresh_meta` at any time.
- Task state is separate and stored in checkpoint state, not in `meta.json`.

## Test Results
- `uv run pytest tests/test_plan_task_state.py`
- Result: 1 passed.

---

## Review & Recommendations (2026-01-16)

### Verdict: **Good, simple design** - Proceed with minor enhancements.

### Strengths
- Clean schema, bounded lists (200 max paths)
- Best-effort updates (won't break user workflows)
- Regenerable via `refresh_meta`
- Clear update triggers defined

### Concerns & Mitigations

| Concern | Mitigation |
|---------|------------|
| **5 files to modify** | Add integration test verifying meta updates on each trigger |
| **No atomic write strategy** | Use temp file + rename pattern (write `meta.json.tmp`, then `rename`) |
| **No schema version** | Add `"version": 1` field for future compatibility |
| **Path overflow undefined** | Document: cap at 200, log warning, truncate oldest |

### Recommended Schema Update (v1)

```json
{
  "version": 1,
  "thread_id": "telegram:123",
  "updated_at": "2026-01-16T18:10:00Z",
  "files": {
    "paths": ["notes/mfa.txt", "docs/contract.pdf"],
    "count": 2,
    "truncated": false,
    "last_updated": "2026-01-16T18:10:00Z"
  },
  "kb": {
    "tables": ["mfa_agreement"],
    "last_updated": "2026-01-16T18:10:00Z"
  },
  "db": {
    "path": "db/db.db",
    "tables": ["timesheet"],
    "last_updated": "2026-01-16T18:10:00Z"
  },
  "reminders": {
    "count": 3,
    "last_updated": "2026-01-16T18:10:00Z"
  }
}
```

Changes:
- Added `"version": 1` for schema compatibility
- Added `"truncated": false` to indicate if path list was capped

### Implementation Notes

1. **Atomic writes**: Always write to `meta.json.tmp` first, then `rename()` to `meta.json`
2. **Error logging**: Log but ignore errors when meta updates fail (best-effort)
3. **Path overflow**: When `paths.length >= 200`, set `truncated: true`, drop oldest entries, log warning
4. **Integration test**: Test that each update trigger (file/KB/DB/reminder) correctly updates meta
